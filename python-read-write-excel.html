<!DOCTYPE html>
<html lang="zh_cn">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Calf" />

        <meta name="description" content="前段时间需要用 Python 来处理 Microsft Excel 文件，尝试了一些不同的方法，记录下来留个印象。
" />
        <meta name="twitter:creator" content="@calfzhou">
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Excel, 程序开发, XlsxWriter, python-excel, xlrd, xlwt, OpenPyXL, Win32Com, Microsoft Excel" />

<meta property="og:title" content="用 Python 读写 Excel 文件 "/>
<meta property="og:url" content="https://blog.gocalf.com/python-read-write-excel" />
<meta property="og:description" content="前段时间需要用 Python 来处理 Microsft Excel 文件，尝试了一些不同的方法，记录下来留个印象。" />
<meta property="og:site_name" content="GoCalf Blog" />
<meta property="og:article:author" content="Calf" />
<meta property="og:article:published_time" content="2013-12-03T20:50:00+08:00" />
<meta property="og:article:modified_time" content="2014-07-31T09:54:00+08:00" />
<meta name="twitter:title" content="用 Python 读写 Excel 文件 ">
<meta name="twitter:description" content="前段时间需要用 Python 来处理 Microsft Excel 文件，尝试了一些不同的方法，记录下来留个印象。">
<meta property="og:image" content="https://blog.gocalf.com/images/2013/12/python-excel.png" />
<meta name="twitter:image" content="https://blog.gocalf.com/images/2013/12/python-excel.png" >

        <title>用 Python 读写 Excel 文件  · GoCalf Blog
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://blog.gocalf.com/theme/css/style.min.css?3c8167af">

        <link rel="shortcut icon" href="https://blog.gocalf.com/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="https://blog.gocalf.com/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="https://blog.gocalf.com/theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://blog.gocalf.com/theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://blog.gocalf.com/theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="https://blog.gocalf.com/theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://blog.gocalf.com/theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="https://blog.gocalf.com/theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://blog.gocalf.com/theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="https://blog.gocalf.com/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="https://blog.gocalf.com/theme/images/apple-touch-icon-180x180.png" type="image/png" />
        <link href="https://blog.gocalf.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="GoCalf Blog - Full Atom Feed" />
        <link href="https://blog.gocalf.com/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="GoCalf Blog - Atom Feed" />
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-24210758-2', 'auto');
    ga('send', 'pageview');
</script>


        <script src="//code.jquery.com/jquery.min.js"></script>
    </head>
    <body class="tex2jax_ignore">
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://blog.gocalf.com/"><span class=site-name>GoCalf Blog</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://blog.gocalf.com
                                    >Home</a>
                                </li>
                                <li ><a href="https://blog.gocalf.com/about">About</a></li>
                                <li ><a href="https://blog.gocalf.com/categories">Categories</a></li>
                                <li ><a href="https://blog.gocalf.com/tags">Tags</a></li>
                                <li ><a href="https://blog.gocalf.com/archives">Archives</a></li>
                                <li><form class="navbar-search" action="https://blog.gocalf.com/search" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://blog.gocalf.com/python-read-write-excel">
                用 Python 读写 Excel 文件
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc" id="">

<ul class="simple">
<li><a class="reference internal" href="#pk" id="id19">超级无敌大 PK</a></li>
<li><a class="reference internal" href="#xlsxwriter" id="id20">XlsxWriter</a><ul>
<li><a class="reference internal" href="#id1" id="id21">优点</a></li>
<li><a class="reference internal" href="#id2" id="id22">缺点</a></li>
</ul>
</li>
<li><a class="reference internal" href="#xlrd-xlwt" id="id23">xlrd&amp;xlwt</a><ul>
<li><a class="reference internal" href="#id3" id="id24">优点</a></li>
<li><a class="reference internal" href="#id4" id="id25">缺点</a></li>
</ul>
</li>
<li><a class="reference internal" href="#openpyxl" id="id26">OpenPyXL</a><ul>
<li><a class="reference internal" href="#id5" id="id27">优点</a></li>
<li><a class="reference internal" href="#id6" id="id28">缺点</a></li>
</ul>
</li>
<li><a class="reference internal" href="#microsoft-excel-api" id="id29">Microsoft Excel API</a><ul>
<li><a class="reference internal" href="#id7" id="id30">优点</a></li>
<li><a class="reference internal" href="#id8" id="id31">缺点</a></li>
<li><a class="reference internal" href="#id9" id="id32">关于初始化</a></li>
<li><a class="reference internal" href="#id10" id="id33">关于窗口可见</a></li>
<li><a class="reference internal" href="#id11" id="id34">关于保存并覆盖已有文件</a></li>
<li><a class="reference internal" href="#excel" id="id35">关于结束 Excel 进程</a></li>
<li><a class="reference internal" href="#id12" id="id36">关于枚举常量</a></li>
</ul>
</li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">
            
            
<p>虽然天天跟数据打交道，也频繁地使用 Excel 进行一些简单的数据处理和展示，但长期以来总是小心地避免用 Python 直接读写 Excel 文件。通常我都是把数据保存为以 TAB 分割的文本文件（TSV），再在 Excel 中进行导入或者直接复制粘贴。</p>
<p>前段时间做一个项目，却不得不使用 Python 直接生成 Excel 文件，后来随着需求的变化，还要对已有的 Excel 文件进行读取。在这个过程中，研究并尝试了一些工具，也走了一些弯路。记录下来，下次再有类似需求的时候就不用漫天遍野地搜索了。</p>
<!-- more -->
<div class="section" id="pk">
<h2><a class="toc-backref" href="#id19">超级无敌大 PK</a></h2>
<p>我主要尝试了四种工具，在此并不会给出他们的排名，因为在不同的应用场景下，做出的选择会不同。</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%"/>
<col width="21%"/>
<col width="22%"/>
<col width="23%"/>
<col width="25%"/>
</colgroup>
<thead valign="bottom">
<tr><th class="head"> </th>
<th class="head"><a class="reference external" href="https://github.com/jmcnamara/XlsxWriter">XlsxWriter</a></th>
<th class="head"><a class="reference external" href="http://www.python-excel.org/">xlrd&amp;xlwt</a></th>
<th class="head"><a class="reference external" href="http://openpyxl.readthedocs.org/">OpenPyXL</a></th>
<th class="head"><a class="reference external" href="http://msdn.microsoft.com/en-us/library/fp179694.aspx">Microsoft Excel API</a></th>
</tr>
</thead>
<tbody valign="top">
<tr><td>介绍</td>
<td>可以创建 Excel 2007
或更高版本的 XLSX
文件</td>
<td>即 <a class="reference external" href="http://www.python-excel.org/">python-excel</a>，含
<a class="reference external" href="https://pypi.python.org/pypi/xlrd">xlrd</a>、<a class="reference external" href="https://pypi.python.org/pypi/xlwt">xlwt</a> 和
<a class="reference external" href="https://pypi.python.org/pypi/xlutils">xlutils</a> 三大模块，分别提供读、写和其他功能</td>
<td>可以读写 Excel 2007 XLSX
和 XLSM 文件</td>
<td>直接通过 COM 组件与Microsoft
Excel 进程通信，调用其各种功能实现对 Excel 文件的操作</td>
</tr>
<tr><td>读</td>
<td>❌</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr><td>写</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr><td>修改</td>
<td>❌</td>
<td>❌</td>
<td>⚠️</td>
<td>✅</td>
</tr>
<tr><td>.xls</td>
<td>❌</td>
<td>✅</td>
<td>❌</td>
<td>✅</td>
</tr>
<tr><td>.xlsx</td>
<td>✅</td>
<td>⚠️</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr><td>大文件</td>
<td>✅</td>
<td>❌</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr><td>功能</td>
<td>强</td>
<td>弱</td>
<td>一般</td>
<td>超强</td>
</tr>
<tr><td>速度</td>
<td>快</td>
<td>快</td>
<td>快</td>
<td>超慢</td>
</tr>
<tr><td>系统</td>
<td>无限制</td>
<td>无限制</td>
<td>无限制</td>
<td>Windows + Excel</td>
</tr>
<tr><td>使用场景</td>
<td><ul class="first last simple">
<li>要创建 XLSX 文件</li>
<li>不需要读取已有文件</li>
<li>需要实现比较复杂的功能</li>
<li>数据量可能会很大</li>
<li>需要跨平台</li>
</ul>
</td>
<td><ul class="first last simple">
<li>要读取 XLS 或 XLSX 文件</li>
<li>要生成 XLS 文件</li>
<li>需要的功能不太复杂</li>
<li>需要跨平台</li>
</ul>
</td>
<td><ul class="first last simple">
<li>要处理 XLSX 文件</li>
<li>需要修改已有文件，或者在写入过程中需要不断修改</li>
<li>需要的功能比较复杂</li>
<li>数据量可能会很大</li>
<li>需要跨平台</li>
</ul>
</td>
<td><ul class="first last simple">
<li>需要处理各种文件格式</li>
<li>需要用到特别复杂的功能</li>
<li>在修改文件时，不希望对原有信息造成任何意外破坏</li>
<li>数据量很小，或者愿意等待</li>
<li>仅在 Windows 中使用</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="xlsxwriter">
<h2><a class="toc-backref" href="#id20">XlsxWriter</a></h2>
<p><a class="reference external" href="https://github.com/jmcnamara/XlsxWriter">XlsxWriter</a> 是我最终选择的用于写操作的工具。顾名思义，它只能用来写文件。</p>
<p>这应该是个比较新的项目，在 GitHub 上看它最早的提交是在 2013 年 1 月份。其官方文档中宣称它支持：</p>
<ul class="simple">
<li>100% compatible Excel XLSX files.</li>
<li>Full formatting.</li>
<li>Merged cells.</li>
<li>Defined names.</li>
<li>Charts.</li>
<li>Autofilters.</li>
<li>Data validation and drop down lists.</li>
<li>Conditional formatting.</li>
<li>Worksheet PNG/JPEG images.</li>
<li>Rich multi-format strings.</li>
<li>Cell comments.</li>
<li>Memory optimisation mode for writing large files.</li>
</ul>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id21">优点</a></h3>
<p>一、功能比较强</p>
<p>相对而言，这是除 Excel 自身之外功能最强的工具了。比如我就用到了它提供的：字体设置、前景色背景色、border 设置、视图缩放（zoom）、单元格合并、autofilter、freeze panes、公式、data validation、单元格注释、行高和列宽设置等等。</p>
<p>最让我惊奇的是，用它生成的带有单元格注释的 Excel 文件，不论是 Excel 2007 还是 Excel 2013 都可正常打开（下面会提到，这个任务用 Excel 自身都无法完成）。</p>
<p>二、支持大文件写入</p>
<p>如果数据量非常大，可以启用 <a class="reference external" href="http://xlsxwriter.readthedocs.org/en/latest/working_with_memory.html">constant memory 模式</a>，这是一种顺序写入模式，得到一行数据就立刻写入一行，而不会把所有的数据都保持在内存中。</p>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id22">缺点</a></h3>
<p>一、不支持读取和修改</p>
<p>作者并没有打算做一个 XlsxReader 来提供读取操作。不能读取，也就无从修改了。它只能用来创建新的文件。我是利用 xlrd 把需要的信息读入后，用 XlsxWriter 创建全新的文件。</p>
<p>另外，即使是创建到一半 Excel 文件，也是无法读取已经创建出来的内容的（信息应该在，但是并没有相应的接口）。因为它的主要方法是 <tt class="docutils literal">write</tt> 而不是 <tt class="docutils literal">set</tt>。当你在某个单元格写入数据后，除非你自己保存了相关的内容，否则还是没有办法读出已经写入的信息。从这个角度看，你无法做到读出 -&gt; 修改 -&gt; 写回，只能是写入 -&gt; 写入 -&gt; 写入。</p>
<p>二、不支持 XLS 文件</p>
<p>XLS 是 Office 2013 或更早版本所使用的格式，是一种二进制格式的文件。XLSX 则是用一系列 XML 文件组成的（最后的 X 代表了 XML）一个压缩包。如果非要创建低版本的 XLS 文件，就请移步 xlwt 吧。</p>
<p>三、暂时不支持透视表（Pivot Table）</p>
<p>透视表是非常麻烦的东西，除了自身复杂的结构外，还需要一套数据缓存。我向作者提出了这个需求，不过这是个很难完全实现的功能，我们慢慢期待吧。</p>
</div>
</div>
<div class="section" id="xlrd-xlwt">
<h2><a class="toc-backref" href="#id23">xlrd&amp;xlwt</a></h2>
<p>我的程序在第一版的时候，使用 <a class="reference external" href="https://pypi.python.org/pypi/xlwt">xlwt</a> 创建 XLS 文件，然后通过 <a class="reference external" href="http://msdn.microsoft.com/en-us/library/fp179694.aspx">Microsoft Excel API</a> 将其转换为 XLSX 文件，并写入高级的 Data Validation（Excel 2007 的 Data Validation 比 Excel 2003 要强大不少）和单元格注释。</p>
<p>我的程序最终的版本也依然用 <a class="reference external" href="https://pypi.python.org/pypi/xlrd">xlrd</a> 从已有的文件中读出所需的信息。</p>
<p><a class="reference external" href="http://www.python-excel.org/">xlrd&amp;xlwt</a> 主要是针对 Office 2013 或更早版本的 XLS 文件格式。</p>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id24">优点</a></h3>
<p>一、支持 XLS 格式</p>
<p>XlsxWriter 和 OpenPyXL 都不支持 XLS 格式，从这个角度看，<a class="reference external" href="http://www.python-excel.org/">xlrd&amp;xlwt</a> 仍然有一定的不可替代性。</p>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id25">缺点</a></h3>
<p>一、对 XLSX 支持比较差</p>
<p>目前 <a class="reference external" href="https://pypi.python.org/pypi/xlrd">xlrd</a> 已经可以读取 XLSX 文件了，有限地支持。至于 <a class="reference external" href="https://pypi.python.org/pypi/xlwt">xlwt</a> 我没有试验过，估计是够呛。</p>
<p>二、对修改的支持比较差</p>
<p>xlrd 和 xlwt 是两个相对独立的模块，虽然 <a class="reference external" href="https://pypi.python.org/pypi/xlutils">xlutils</a> 提供方法帮助你把 <tt class="docutils literal">xlrd.Book</tt> 对象复制到 <tt class="docutils literal">xlwt.Workbook</tt> 对象，但跟 XlsxWriter 类似，后者只是提供 write 方法，使得你无法很容易地获取当前已经写入的数据并进行有针对性的修改。如果非要这样做，你要不断地保存，然后再用新的 <tt class="docutils literal">xlrd.Book</tt> 对象读取你要的信息，还是比较麻烦的。</p>
<p>三、功能很弱</p>
<p>除了最基本的写入数据和公式，xlwt 所提供的功能非常少（Excel 2013 本身支持的功能也就很少）。对于读取也是一样的，很多信息在读入时就丢失掉了。</p>
</div>
</div>
<div class="section" id="openpyxl">
<h2><a class="toc-backref" href="#id26">OpenPyXL</a></h2>
<p><a class="reference external" href="http://openpyxl.readthedocs.org/">OpenPyXL</a> 是比较综合的一个工具，能读能写能修改，功能还算可以但也有很大的缺陷。我在中间版本的时候是打算完全依赖它的，但后来发现一个严重的问题就放弃了。</p>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id27">优点</a></h3>
<p>一、能读能写能修改</p>
<p>OpenPyXL 的工作模式跟 XlsxWriter 和 xlwt 有很大的区别，它用的是 getter/setter 模式。你可以随时读取某个单元格的内容，并根据其内容进行相应的修改，OpenPyXL 会帮你记住每个单元格的状态。</p>
<p><strong>特别需要注意的一点：</strong>虽然它支持修改已有文件，但由于其所支持的功能有限，读入文件时会忽略掉它所不支持的内容，再写入时，这些内容就丢失了。因此使用时一定要慎重。比如下面的缺点中提到它无法读入公式，那如果你修改一个带有公式的文件，保存之后，所有的公式就都没有了。</p>
<p>二、功能还算可以</p>
<p>整体来讲，它所支持的功能介于 XlsxWriter 和 xlwt 之间。</p>
</div>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id28">缺点</a></h3>
<p>一、不支持 XLS</p>
<p>这件事情只能让 xlrd 和 xlwt 去做。</p>
<p>二、不支持读取公式</p>
<p>这其实是个不太简单的事情，虽然我没尝试过，但相信 xlrd 也做不好这件事。</p>
<p>Excel 的单元格如果是一个公式，它内部会同时保存公式本身和运算结果的缓存。用 OpenPyXL 读取单元格内容，它不会告诉你这个单元格的公式是什么，甚至不会告诉你这个单元格存的是公式，它只会拿到这个缓存的运算结果。我本来想利用它判别单元格是不是用了公式，然后做出不同的处理。结果遇到了这个问题，最后只好采取了其他变通的方式去做。</p>
</div>
</div>
<div class="section" id="microsoft-excel-api">
<h2><a class="toc-backref" href="#id29">Microsoft Excel API</a></h2>
<p>大部分 Windows 环境的开发人员都会选择 <a class="reference external" href="http://msdn.microsoft.com/en-us/library/fp179694.aspx">Microsoft Excel API</a>。实际上不仅仅是 Python，几乎各种语言都有相应的方法使用它，因为核心的逻辑完全是由 Microsft
Excel 自身提供的。语言相关的部分只是负责跟 Windows 的 COM 组件进行通信。</p>
<p>在 Python 中首先需要安装 <a class="reference external" href="http://sourceforge.net/projects/pywin32/">Python for Windows extensions</a>（<a class="reference external" href="http://sourceforge.net/projects/pywin32/">pywin32</a>），具体的文档可以查阅 <a class="reference external" href="http://docs.activestate.com/activepython/2.4/pywin32/win32_modules.html">Win32 Modules</a> 和 <a class="reference external" href="http://docs.activestate.com/activepython/2.4/pywin32/com.html">Python COM</a>。</p>
<p>当然你还必须要安装某一个版本的 Microsoft Office Excel，它内部的 DLL 负责实际的操作。</p>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id30">优点</a></h3>
<p>一、最大的优点：强大无极限</p>
<p>因为直接与 Excel 进程通信，你可以做任何在 Excel 里可以做的事情。</p>
<p>二、文档丰富</p>
<p>MSDN 上的文档绝对是世界上最优秀的文档。没有之一。</p>
<p>三、调试方便</p>
<p>你完全可以直接在 Excel 里面用宏先调试你想要的效果。甚至如果你不清楚怎么用程序实现某个操作，你可以通过宏录制的方法得到该操作的处理代码。</p>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id31">缺点</a></h3>
<p>一、致命的缺点：慢到死</p>
<p>因为需要与 Excel 进程通信，其效率是非常低的。</p>
<p>如果让 Excel 窗口可见，随着程序的运行，你可以看到每一句程序所带来的变化，单元格的内容一个一个地改变。如果要写入的数据很多，那速度是无法忍受的。</p>
<p>二、平台限制</p>
<p>目前还没有发现可以在非 Windows 系统使用它的方法。</p>
<p>另外，基于它的程序能做什么事情，很大程度上依赖于当前系统所安装的 Excel 版本。不同的版本在功能上有很大的差异，API 也会有差异。用起来会比较麻烦。</p>
<p>三、Excel 自身 bug 导致的问题</p>
<p>我刚好发现了其中一个，这和 Python 没有任何关系，可以完全在 Excel 中手动复现。在 Excel 2007 中随便创建一个文件，给某个单元格添加注释，保存。换台电脑，用 Excel 2013 打开，就会报错，然后注释就消失了。</p>
<p>同样如果你的程序在一台装有 Excel 2007 的机器上创建一个带有注释的 Excel 文件，把这个文件拿到 Excel 2013 中打开也会报错，也看不到注释。反过来也一样。</p>
</div>
<div class="section" id="id9">
<h3><a class="toc-backref" href="#id32">关于初始化</a></h3>
<p>Excel 的 com 接口的具体细节我就不介绍了，需要的话直接查阅相关的 MSDN 文档即可。这里只提几个特殊的小问题。</p>
<p>要想得到一个可以操作的 excel 对象，一般可以有两种方式：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">win32com.client</span>

<span class="n">excel</span> <span class="o">=</span> <span class="n">win32com</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">Dispatch</span><span class="p">(</span><span class="s1">'Excel.Application'</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">win32com.client</span>

<span class="n">excel</span> <span class="o">=</span> <span class="n">win32com</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">DispatchEx</span><span class="p">(</span><span class="s1">'Excel.Application'</span><span class="p">)</span>
</pre></div>
<p>二者的区别在于，Dispatch 方法会试图寻找并复用一个已有的 Excel 进程（比如你已经在运行着的 Excel 程序），而 DispatchEx 则一定会创建一个新的 Excel 进程。一般情况使用前者就可以了，还能节省一些资源的开销。但也会带来一些麻烦，有一些状态是在一个 Excel 进程内共享的，你在同进程的其他窗口内操作有可能会影响到 Python 程序所要进行的处理，导致各种错误。比如当你手动开启的 Excel 窗口中，某个单元格正处于编辑状态，那 Python 程序控制的大部分操作都有可能失败（即使它操作的是另一个文件），因为一个 Excel 进程中无法让两个单元格同时被编辑。</p>
<p>为了避免麻烦，我一般都使用 DispatchEx 方法。</p>
</div>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id33">关于窗口可见</a></h3>
<p>可以让新启动的 Excel 进程窗口可见，就像你通过双击桌面上的图标启动一样，程序所控制的每一步操作，在这个窗口中都可以观察得到。你也可以同时进行手动的操作，但一旦这样做，很有可能使你的 Python 程序崩溃。</p>
<p>窗口不可见也会带来一些麻烦，前面说了，通过 Python 启动的 Excel 进程跟你直接从桌面打开的 Excel 进程没有什么区别，在使用 Excel 的过程中，我们经常会遇到各种弹出的错误、警告或者提示框，这些在用 Python 处理时也有可能遇到。尤其当你的程序还没完全调试好时。</p>
<p>我一般都会让程序控制的 Excel 进程在调试过程中可见，正式使用时不可见，通过类似这样的命令（假设你有一个叫做 <tt class="docutils literal">is_debug</tt> 的变量记录当前是否在调试状态）：</p>
<div class="highlight"><pre><span></span><span class="n">excel</span> <span class="o">=</span> <span class="n">win32com</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">DispatchEx</span><span class="p">(</span><span class="s1">'Excel.Application'</span><span class="p">)</span>
<span class="hll"><span class="k">if</span> <span class="n">is_debug</span><span class="p">:</span>
</span><span class="hll">    <span class="n">excel</span><span class="o">.</span><span class="n">Visible</span> <span class="o">=</span> <span class="bp">True</span>
</span></pre></div>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id34">关于保存并覆盖已有文件</a></h3>
<p>打开和保存文件的细节不在这里多说了，可以查看 MSDN 中相关的 API 介绍，非常详细。这里只说一下在另存为时，如果目标文件已经存在怎么办。Excel 的 API 另存为方法似乎并没有提供参数决定是否直接覆盖同名的目标文件，在窗口操作中，这种情况会弹出一个确认框来让用户决定。我们的程序当然不想这么做，实际上如果你按照上面所说的让窗口不可见，你也就看不到弹出的窗口。</p>
<p>可以把 DisplayAlert 属性关闭，这样 Excel 就不会弹出确认窗，而是直接覆盖同名文件。</p>
<div class="highlight"><pre><span></span><span class="n">orig_display_alerts</span> <span class="o">=</span> <span class="n">excel</span><span class="o">.</span><span class="n">DisplayAlerts</span>
<span class="hll"><span class="n">excel</span><span class="o">.</span><span class="n">DisplayAlerts</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class="k">try</span><span class="p">:</span>
    <span class="n">book</span><span class="o">.</span><span class="n">SaveAs</span><span class="p">(</span><span class="n">save_as_file_path</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">excel</span><span class="o">.</span><span class="n">DisplayAlerts</span> <span class="o">=</span> <span class="n">orig_display_alerts</span>
</pre></div>
</div>
<div class="section" id="excel">
<h3><a class="toc-backref" href="#id35">关于结束 Excel 进程</a></h3>
<p>进程是一种资源，我们申请了资源，在用完之后就必须要释放掉。尤其如果你隐藏了 Excel 窗口，用户只有查看系统进程，否则无法关闭你所开启的进程。</p>
<p>但是一个 Excel 进程是可以同时开启多个文件的，这些文件可能是你程序的其他部分开启的，也可能是用户自己开启的。这样你就不能随意地结束 Excel 进程，否则会影响到其他人或程序的操作。</p>
<p>我一般会在我的处理完成后（关闭了我自己打开或者创建的 Excel 文件），判断一下当前 Excel 进程是否还开启着其他的文档，如果没有了才会结束该进程。</p>
<div class="highlight"><pre><span></span><span class="hll"><span class="n">number_of_workbooks</span> <span class="o">=</span> <span class="n">excel</span><span class="o">.</span><span class="n">Workbooks</span><span class="o">.</span><span class="n">Count</span>
</span><span class="k">if</span> <span class="n">number_of_workbooks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">'there are still </span><span class="si">%d</span><span class="s1"> workbooks opened in excel process, not quit excel application'</span><span class="p">,</span>
        <span class="n">number_of_workbooks</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">'no workbook opened in excel process, quiting excel application instance ...'</span>
    <span class="p">)</span>
    <span class="n">excel</span><span class="o">.</span><span class="n">Quit</span><span class="p">()</span>

<span class="k">del</span> <span class="n">excel</span>
</pre></div>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id36">关于枚举常量</a></h3>
<p>Excel API 中有各种各样的枚举常量，我还没有找到在 Python 中直接引用这些常量的方法，目前的办法是找到所需的常数的值，自己定义这些常数。比如我用到了如下这些枚举常量：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExcelConstants</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># XlFileFormat Enumeration</span>
    <span class="n">xlOpenXMLWorkbook</span> <span class="o">=</span> <span class="mi">51</span>  <span class="c1"># Open XML Workbook.</span>

    <span class="c1"># XlDVType Enumeration</span>
    <span class="n">xlValidateList</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># Value must be present in a specified list.</span>

    <span class="c1"># XlDVAlertStyle Enumeration</span>
    <span class="n">xlValidAlertStop</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Stop icon.</span>

    <span class="c1"># Constants Enumeration</span>
    <span class="n">xlCenter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4108</span>

    <span class="c1"># XlLineStyle enumeration</span>
    <span class="n">xlContinuous</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</td></tr></table><p>要想知道某一个枚举常量的数值，可以查阅 MSDN 中 <a class="reference external" href="http://msdn.microsoft.com/en-us/library/office/ff838815.aspx">Excel Enumerations</a> 相关的资料。</p>
<p>【2014 年 7 月 31 日更新】感谢 <a class="reference external" href="https://blog.gocalf.com/python-read-write-excel.html#comment-1329532357">@依云</a> 提醒，在 Python 也能够直接引用相关的常量，即通过 <tt class="docutils literal">win32com.client.constants</tt> 获取常量的值。不过这里还有一点比较 tricky 的地方，如果直接用 Dispatch 或者 DispatchEx 得到 Excel 对象，是无法从 constants 中取出常量值的，需要 <a class="reference external" href="http://timgolden.me.uk/python/win32_how_do_i/generate-a-static-com-proxy.html">手动运行 makepy</a>，或者通过 <tt class="docutils literal">win32com.client.gencache.EnsureDispatch</tt> 获得 Excel 对象：</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">win32com</span>
<span class="kn">from</span> <span class="nn">win32com.client</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="n">excel</span> <span class="o">=</span> <span class="n">win32com</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">gencache</span><span class="o">.</span><span class="n">EnsureDispatch</span><span class="p">(</span><span class="s1">'Excel.Application'</span><span class="p">)</span>
<span class="k">print</span> <span class="n">constants</span><span class="o">.</span><span class="n">xlOpenXMLWorkbook</span>  <span class="c1"># will be 51</span>
<span class="k">print</span> <span class="n">constants</span><span class="o">.</span><span class="n">xlCenter</span>  <span class="c1"># will be -4108</span>
</pre></div>
</td></tr></table></div>
</div>



                <p id="post-share-links">
    Like this post? Share on:
    <a href="https://twitter.com/intent/tweet?text=%E7%94%A8%20Python%20%E8%AF%BB%E5%86%99%20Excel%20%E6%96%87%E4%BB%B6&url=https%3A//blog.gocalf.com/python-read-write-excel&via=calfzhou&hashtags=excel" target="_blank" title="Share on Twitter">Twitter</a>
    ❄
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//blog.gocalf.com/python-read-write-excel" target="_blank" title="Share on Facebook">Facebook</a>
    ❄
    <a href="mailto:?subject=%E7%94%A8%20Python%20%E8%AF%BB%E5%86%99%20Excel%20%E6%96%87%E4%BB%B6&amp;body=https%3A//blog.gocalf.com/python-read-write-excel" target="_blank" title="Share via Email">Email</a>
    </p>

            
            






<section>
    <h6 style="display:none;">Comments</h6>
    <p id="comment-message">So what do you think? Did I miss something? Is any part unclear? Leave your comments below. </p>

    <div class="accordion" id="accordion2">
        <div class="accordion-group">
            <div class="accordion-heading">
                <a class="accordion-toggle disqus-comment-count comment-count"
                   data-toggle="collapse"
                   data-parent="#accordion2"
                   data-disqus-identifier="https://blog.gocalf.com/python-read-write-excel"
                   href="https://blog.gocalf.com/python-read-write-excel#comment_thread"
                   id="comment-accordion-toggle">
                    Comments
                </a>
            </div>
            <div id="comment_thread" class="accordion-body collapse">
                <div class="accordion-inner">
                    <div class="comments">
                        <div id="disqus_thread"></div>
                        <script>
    var disqus_shortname = 'gocalfblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());

    var disqus_identifier = 'https://blog.gocalf.com/python-read-write-excel';
    var disqus_url = 'https://blog.gocalf.com/python-read-write-excel';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


                        <script src="https://utteranc.es/client.js"
        data-repo="calfzhou/gocalf-blog"
        data-issue-term="https://blog.gocalf.com/python-read-write-excel"
        data-label="blog-comment"
        data-theme="github-light"
        crossorigin="anonymous"
        async>
</script>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

            <hr/>
<section>
    <h2>Keep Reading</h2>
<ul class="related-posts-list">
<li><a href="https://blog.gocalf.com/excel-find-from-right" title="Excel 从右向左查找">Excel 从右向左查找</a></li>
<li><a href="https://blog.gocalf.com/excel-variable-width-column-chart" title="在 Excel 中制作不等宽柱状图">在 Excel 中制作不等宽柱状图</a></li>
</ul>
<hr />
</section>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="https://blog.gocalf.com/scale-embedded-svg" title="Previous: 让页面中嵌入的 SVG 图片可以缩放">让页面中嵌入的 SVG 图片可以缩放</a></li>
                <li class="next-article"><a href="https://blog.gocalf.com/excel-variable-width-column-chart" title="Next: 在 Excel 中制作不等宽柱状图">在 Excel 中制作不等宽柱状图</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2013-12-03T20:50:00+08:00">Dec 3, 2013</time>
<h4>Last Updated</h4>
<time datetime="2014-07-31T09:54:00+08:00">Jul 31, 2014</time>

            <h4>Category</h4>
            <a class="category-link" href="https://blog.gocalf.com/categories#programming-ref">程序开发</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://blog.gocalf.com/tags#excel-ref">Excel
                    <span>3</span>
</a></li>
            </ul>
<h4>Stay in Touch</h4>
<div id="sidebar-social-link">
    <a href="mailto:calf.zhou+blog@gmail.com" title="" target="_blank" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Gmail" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#fff"/><rect width="362" height="272" x="75" y="120" fill="#f2f2f2" rx="8%"/><path fill="#d54c3f" d="M120 392H97c-12 0-22-10-22-23V143h45z"/><path fill="#b63524" d="M392 392h23c12 0 22-10 22-23V143h-45z"/><path fill-opacity=".05" d="M256 286L120 392V187z"/><path fill-opacity=".08" d="M82 159l235 233h75V159z"/><path stroke-linecap="round" fill="none" stroke="#de5145" stroke-width="45" d="M97 143l159 115 159-115"/><path fill="#f2f2f2" d="M415 120c-5 0-10 2-13 4L256 230 110 124c-3-2-8-4-13-4z"/></svg>
    </a>
    <a href="https://github.com/calfzhou" title="" target="_blank" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://t.me/calfzhou" title="" target="_blank" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Telegram" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#37aee2"/><path fill="#c8daea" d="M199 404c-11 0-10-4-13-14l-32-105 245-144"/><path fill="#a9c9dd" d="M199 404c7 0 11-4 16-8l45-43-56-34"/><path fill="#f6fbfe" d="M204 319l135 99c14 9 26 4 30-14l55-258c5-22-9-32-24-25L79 245c-21 8-21 21-4 26l83 26 190-121c9-5 17-3 11 4"/></svg>
    </a>
    <a href="https://www.facebook.com/calfzhou" title="" target="_blank" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Facebook" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1877f2"/><path d="M355.6 330l11.4-74h-71v-48c0-20.2 9.9-40 41.7-40H370v-63s-29.3-5-57.3-5c-58.5 0-96.7 35.4-96.7 99.6V256h-65v74h65v182h80V330h59.6z" fill="#fff"/></svg>
    </a>
    <a href="https://twitter.com/calfzhou" title="" target="_blank" rel="nofollow">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
</div>
            





            





        </div>
        </section>
</div>
</article>
                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        &copy; 2019 gocalf.com
    </div>

    <div>
        <span class="site-name">GoCalf Blog</span> - 1/100 ALGO&amp;MATH; 1/100 IT&amp;GAME; 1/100 INFO&amp;SHARING; 1/100 WHO KNOWS
    </div>



    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow">Elegant</a>
        Hosted on:
        <a href=https://pages.github.com/ target="_blank" rel="nofollow">
            GitHub Pages
        </a>
    </div>
</footer>            <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
        <script type="text/javascript">
            $('.article-content a.external').attr('target', '_blank');
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>